<% 
user_emails=@user_emails
project_names=@project_names
t_list=@t_list
%>
<head>
  <link rel="stylesheet" href="/stylesheets/demo.css">
  <link rel="stylesheet" href="/closure-library/closure/goog/css/autocomplete.css">
   <%= javascript_include_tag 'jquery.fileupload-ui','jquery.fileupload' %>
</head>
	<div class="modal add-item-modal">
	<div class="modal-top-left"></div>
	<div class="modal-top-center">
		<a class="save-btn" id="t_add" href="#message_create" >Save</a>
		<a class="cancel-btn" id="t_can" href="#message_cancel" >Cancel</a>
		Add New Task
	</div>
	<div class="modal-top-right"></div>
	<div class="modal-body-contain">
		<div class="modal-body">
			<div class="modal-input">
<%form_for :task, :url=>({ :controller => "tasks", :action => "create" }), :html=>({:target=>"upload_frame",:multipart=>true,:id=>"taskf"}) do |f|%>
				<fieldset>
					<label>Task</label>
							<%=f.text_field  'name', :class=>"textfield" %>
		    </fieldset>
			    <fieldset>
					<label>Project:</label>
		       		<% p session[:project_name] %>
					<% if session[:project_name] %>
					 		<%=f.text_field  'project', :class=>"textfield", :id=>"project_val" , :value=>"#{session[:project_name]}", :disabled=>true%>
					 <% else %>
					 		<%=f.text_field  'project', :class=>"textfield", :id=>"project_val" %>
					 <% end %>
			    </fieldset>
					<fieldset>
					<label>Assign:</label>
						<%=f.text_field  'recipient', :class=>"textfield", :id=>"assign_to"  %>
						    </fieldset>
					<fieldset>
					<label>Notify:</label>
						<%=f.text_field  'notify', :class=>"textfield", :id=>"t_notify"%>
			    </fieldset>
					<fieldset>
					<label>Tasklist:</label>
						<%=f.text_field  'tasklist', :class=>"textfield", :id=>"t_list"  %>
					</fieldset>
					<fieldset>
					<label>Due_Date:</label>
						<%=f.text_field  'due_date', :class=>"textfield" ,:id=>"txtInput3"%>
							    </fieldset>
			    <fieldset id="task_txtarea">
					<label>Message:</label>
		       		<%=f.text_area 'message', :class=>'textarea', :rows=>"", :cols=>"", :display=>"none"%>
			    </fieldset>
				<% end %>
				<% form_for :attachs, :url=>{:controller=>"attachments", :action=>"create"}, :html=>{:multipart=>true, :id=>"form3"} do |f3| %>
						<fieldset id="attach" class="open">
						<div id="loader1" style="display:none;">
	           <img src="/images/ajax-loader(2).gif" />
       </div>
					<label>Attachments:</label>
					<div  id="attach_upload" class="attachment-upload" style="display:none;">
						<div class="drag-drop">Drag and drop files here</div>
						<table id="files"></table>
						<div id="attachment_files"> </div>
						</div>
		        </fieldset>
					    <button id="start_uploads", style="display:none;">Start uploads</button>
		      <% end %>
			</div>
			</div>
		</div>
	</div>
	<div class="modal-bottom-left"></div>
	<div class="modal-bottom"></div>
	<div class="modal-bottom-right"></div>
<iframe id='upload_frame' name="upload_frame" style="width:0px;height:0px;border:0px;display:none" src="about:blank"></iframe>
<script type="text/javascript">
<%=names=[]%>
<%=tlist=[]%>
<%=projects=[]%>
	<% user_emails.each do |f|%>
		<%names<<f <<","%>
		<%end%>
			<%project_names.each do |f|%>
			  <%projects<<f <<","%>
	<%end%>
	<%t_list.each do |f|%>
			  <%tlist<<f <<","%>
	<%end%>
	var userEmails = "<%= names %>";	
var projectNames = "<%= projects %>";
var tasklist="<%= tlist %>";
userEmails=userEmails.split(',');
	projectNames=projectNames.split(',');
    var ac1 = new goog.ui.AutoComplete.Basic(userEmails, document.getElementById('assign_to'), true);
		var ac1 = new goog.ui.AutoComplete.Basic(userEmails, document.getElementById('t_notify'), true);
    var ac2 = new goog.ui.AutoComplete.Basic(projectNames, document.getElementById('project_val'),false);
		 var ac2 = new goog.ui.AutoComplete.Basic(tasklist, document.getElementById('t_list'),false);
		</script>
		<script>
	$('#task_txtarea').click(function(){
document.getElementById('task_message').style.display="block";
	document.getElementById('task_txtarea').className="open";
	});
	$('#txtInput3').keydown(function(event){
	if (event.keyCode == 9) {
  document.getElementById('task_message').style.display="block";
	document.getElementById('task_txtarea').className="open";
	$('.drag-drop').focus();
	}
	});
	$('#task_message').keydown(function(event){
	if (event.keyCode == 9) {
  document.getElementById('attach_upload').style.display="block";
	$('#task_message').focus();
	}
	});
	$('#attach').click(function(){
	document.getElementById('attach_upload').style.display="block";
	});

	$(function () {
    $('#form3').fileUploadUI({
    uploadTable: $('#files'),
    downloadTable: $('#attachment_files'),
			onProgress: function(event, files, index, xhr, handler){
		$('#loader1').show();
		},
    buildUploadRow: function (files, index) {
        return false;    },
    buildDownloadRow: function (file) {
a=file.id;
var original=file.file
var b=original.lastIndexOf('.')
var c=original.substring(b)
var d=original.split(c)[0]
if(d.length > 12)
{
   var e=d.substring(original,10)
   var file1=e.concat(c)
 }
 	   return $('<div id="attachment_' + a + '" class="attachment">'+'<a href="javascript:delete_attachment('+a+');"> Remove </a>' +'<span class="filename">' + file.file+ '</span></div>');
    },
			onComplete:function (event, files, index, xhr, handler) {
    $('#loader1').hide();
}
});
});
function delete_attachment(file)
{
 $.ajax({
      url:'/remove_attach/'+file,
      type: 'get',
			 success: function(file){
			 document.getElementById('attachment_'+file).style.display="none";
			 }
    });
}
$('#project_val').keydown(function(event){
if (event.keyCode == 9){
if (document.getElementById("project_val").value!="")
{
proj=document.getElementById("project_val").value
$.ajax({
      url:'/tasks/'+proj+'/project_tasklists',
      type: 'get',
			 success: function(data){
			 alert(data.data);
			 tlist=data.data;
			 alert(tlist);
			// document.getElementById('attachment_'+file).style.display="none";
			 }
			 });
			 }
			 }
			 });
</script>