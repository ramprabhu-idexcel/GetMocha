<div class="l-panel-contain">
	<% if @projects %>
		<%= render :partial=>'project_list' %>
	<% end %>
</div>
<div class="m-panel-contain">
  <div class="m-panel" id="message_area">
    
  </div><!--end of m-panel-->
</div><!--end of m-panel-contain-->
<div class="r-panel-contain">
  <div class="r-panel">
  
    <%= render 'add_comment'%>
    
    <div id="comment_area">
  
    </div>
    
    <div class="expand-all" style="display:none;">
      <a href="#" id="message_expand">
        <span class="icon"></span>
        <span>Expand all comments</span>
      </a>
    </div>
    
  </div>
</div><!--end of r-panel-contain-->
<script>
var Message=true;
$.messages;

 (function($) {

            
           var restfulApp = Backbone.Controller.extend({
               restfulUrl: "http://localhost:3000/",
               routes: {
               '*message/:project_id' : 'projectMessage',
               "*page":                    "findMessage", //This simply matches any urls that weren't caught above and assigns it to "page"
               },
                
              findMessage: function( page ){
                if( page=="all_messages" || page=="starred_messages") {
                    var restfulPageUrl = this.restfulUrl + page  
                    this.loadRestfulData( restfulPageUrl );
                    $('.sort-by').show();
                    $('.message_header').hide();
                    $('#comment_area').html('');
                }
               },
               projectMessage:function(page){
                  var path=(window.location+"").split('#')[1];
                  if(/^all_messages\/[1-9]/.test(path))
                  {
                    var restfulPageUrl = this.restfulUrl + path  
                    this.loadCommentData( restfulPageUrl );         
                  }
                  else{
                    var restfulPageUrl = this.restfulUrl + path  
                    this.loadRestfulData( restfulPageUrl );    
                    $('.message_header').hide();
                    $('#comment_area').html('');                    
                  }
                  $('.sort-by').show();
               },
               loadRestfulData: function( pageUrl ){
                   $.ajax({
                       url: pageUrl,
                       success: function(data){  
                        $.messages=data
                        var items=[];
                        $.each(data,function(index,val){
                          items.push('<div class="date-bar"><a href="#">'+parse_date(index)+'</a></div>');
                          $.each(val,function(i,v){
                            items.push('<div class="message messow '+(v.activity.is_read ? "" : " unread")+'" id= "msac'+v.activity.id+'"><div class="left-icons"><div class="avatar-mini"></div><img alt="avatar" class="avatar-mini-img" src="/images/content/stuart-avatar.jpg"/>')
                            if(v.activity.is_starred)
                            {
                              items.push('<a class="message-star" href="#">Star</a>');
                            }
                           // <div class="has-attachment"></div>
                            var date=parse_datetime(v.activity.updated_at)
                            items.push('</div><div class="info"><span class="name">Stuart Bowness</span><span class="message-time">'+date+'</span></div>')
                            items.push('<div class="excerpt"><h4>'+v.activity.resource.subject+'</h4><p>'+v.activity.resource.message+'</p></div><div class="clear-fix"></div></div>');
                            result=items.join(' ')
                            $('#message_area').html(result);

                          });
                        });
                      }
                   });
               },
               loadCommentData :function(pageUrl){
                var comments=[]
                  $.ajax({
                      url: pageUrl,
                      success: function(data){  
                        comments.push('<div class="message-body"><h2>'+data.message.subject+'<a class="edit" href="#">Edit</a></h2>');
                        comments.push('<p class="post-time">'+data.message.updated_at+' by <a href="#">'+data.message.name+'</a></p><hr/>');
                        comments.push('<div class="main-content"><p>'+data.message.message+'<a class="edit" href="#">Edit</a></p></div>');
                        comments.push('<p class="subscribers">Subscribed: Jessa Ma and <a href="/subscribed-wrap">11 others</a> | <a href="#">unsubscribe</a></p></div>');
                        $.each(data.comments,function(index,comment){
                          comments.push('<div class="prev-messages"><div class="message message_comments '+(comment.is_starred ? "starred" : "" )+' " ><div class="message-body"><a class="message-star" href="#">Star</a>');
                          comments.push('<a class="name" href="#">'+comment.user+'</a><div class="has-attachment"></div><span class="message-time">'+comment.created_at+'</span>');
                          comments.push('<div class="comment"><p>'+comment.comment+'</p>');
                          comments.push('<a class="reply-link" href="#">Reply</a></div></div></div></div>');
                        });
                        var result=comments.join(' ');
                        $('#comment_area').html(result);
                        if(data.comments.length>0)
                        $('.expand-all').show();
                      }
                     });
               }
            });

           var app = new restfulApp;
           //Initiate a new history and controller class
           Backbone.emulateHTTP = true;
           Backbone.emulateJSON = true
           Backbone.history.start();
 
       })(jQuery);
       
       
       </script>